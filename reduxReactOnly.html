<!DOCTYPE html>
<html>
<head>
    <title>Todos/Goals</title>
    <!-- Latest version of redux -->
    <!-- Added a global property called 'Redux' -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>
    <script src='https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
    <!-- Created dummy api instead of creating a server -->
    <script src='API.js'></script>
</head>
<body>
  <div id="app"></div>

  <script type='text/javascript'>
    function generateId () {
      return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
    }
    // Library for managing state inside the application
    // It contains Reducers, actions, 'createStore' function. (similar to Redux)


    // DELETED LIBRARY CODE FOR REDUX IMPLEMENTATION (check redux.html for reference)

    // App Code
    const ADD_TODO = 'ADD_TODO'
    const REMOVE_TODO = 'REMOVE_TODO'
    const TOGGLE_TODO = 'TOGGLE_TODO'
    const ADD_GOAL = 'ADD_GOAL'
    const REMOVE_GOAL = 'REMOVE_GOAL'
    const RECIEVE_DATA = 'RECEIVE_DATA'

    function addTodoAction (todo) {
      return {
        type: ADD_TODO,
        todo,
      }
    }
    function removeTodoAction (id) {
      return {
        type: REMOVE_TODO,
        id,
      }
    }
    function toggleTodoAction (id) {
      return {
        type: TOGGLE_TODO,
        id,
      }
    }
    function addGoalAction (goal) {
      return {
        type: ADD_GOAL,
        goal,
      }
    }
    function removeGoalAction (id) {
      return {
        type: REMOVE_GOAL,
        id,
      }
    }
    function receiveDataAction(todos, goals) {
        return {
            type: RECIEVE_DATA,
            todos,
            goals,
        }
    }

    // Redux Middleware
    const checker = (store) => (next) => (action) => {
      if (
        action.type === ADD_TODO &&
        action.todo.name.toLowerCase().indexOf('atlanta') !== -1
      ) {
        return alert ('Atlanta?? You sure?!')
      }

      if (
        action.type === ADD_GOAL &&
        action.goal.name.toLowerCase().indexOf('atlanta') !== -1
      ) {
        return alert ('Atlanta, for realz?!')
      }

      return next(action)
    } 

    // Logger - ways to check the status in the console.
    const logger = (store) => (next) => (action) => {
      console.log(action.type)
      console.log('the action: ', action)
      const result = next(action)
      console.log('the new state: ', store.getState())
      console.groupEnd()
      return result
    }

    // Reducer function
    function todos (state = [], action) {
      switch(action.type) {
        // Action type(s)
        case ADD_TODO :
          return state.concat([action.todo])
        case REMOVE_TODO :
          return state.filter((todo) => todo.id !== action.id)
        case TOGGLE_TODO :
          return state.map((todo) => todo.id !== action.id ? todo :
            Object.assign({}, todo, {complete: !todo.complete})
          )
        case RECIEVE_DATA :
            return action.todos
        default :
          return state
      }
    }

    function goals (state = [], action) {
      switch(action.type) {
        case ADD_GOAL :
            return state.concat([action.goal])
        case REMOVE_GOAL :
            return state.filter((goal) => goal.id !== action.id)
        case RECIEVE_DATA :
            return action.goals
        default :
          return state
      }
    }

    // NO NEED because of REDUX below - recreation
    // Root Reducer (separate state of the store to reducers) Before the 'store' combineds the Reducers
    // function app (state = {}, action) {
    //   return {
    //     todos: todos(state.todos, action),
    //     goals: goals(state.goals, action)
    //   }
    // }

    // Added 'REDUX.' - REAL THING
    // Smart enough to know and reference todos and goals
    // Redux Middleware added for checking specific word*
    const store = Redux.createStore(Redux.combineReducers({
      todos,
      goals
    }), Redux.applyMiddleware(checker, logger))
    </script>

    <!-- 4 React components - App, Goals, Todos, List -->
    <script type="text/babel">
        function List (props) {
            return (
                <ul>
                    {props.items.map((item) => (
                        <li key={item.id}>

                            <span onClick={() => props.toggle && props.toggle(item.id)}
                            style={{textDecoration: item.complete ? 'line-through' : 'none'}}>
                                {item.name}
                            </span>
                            <button onClick={() => props.remove(item)}>X</button>
                        </li>
                    ))}
                </ul>
            )
        }

        class Todos extends React.Component {
            addItem = (e) => {
                e.preventDefault()
                const name = this.input.value
                this.input.value = ''
                
                // Access from <App /> as props
                // Sharing same state
                this.props.store.dispatch(addTodoAction({
                    id: generateId(),
                    name,
                    complete: false
                }))
            }
            // Removing function item from the list
            removeItem = (todo) => {
                this.props.store.dispatch(removeTodoAction(todo.id))
            }
            toggleItem = (id) => {
                this.props.store.dispatch(toggleTodoAction(id))
            }
            render() {
                return (
                    <div>
                        <h1>Todo List</h1>
                        <input
                            type='text'
                            placeholder='Add Todo'
                            ref={(input) => this.input = input}
                        />
                        <button onClick={this.addItem}>Add Todo</button>

                        <List 
                            items={this.props.todos}
                            remove={this.removeItem}
                            toggle={this.toggleItem}
                        />
                    </div>
                )
            }
        }

        class Goals extends React.Component {
            addItem = (e) => {
                e.preventDefault()
                const name = this.input.value
                this.input.value = ''
                
                // Access from <App /> as props
                // Sharing same state
                this.props.store.dispatch(addGoalAction({
                    id: generateId(),
                    name,
                }))
            }
            removeItem = (goal) => {
                this.props.store.dispatch(removeGoalAction(goal.id))
            }
            render() {
                return (
                    <div>
                        <h1>Goals</h1>
                        <input
                            type='text'
                            placeholder='Add Goal'
                            ref={(input) => this.input = input}
                        />
                        <button onClick={this.addItem}>Add Goal</button>
                        <List 
                            // this is from App render getstate()
                            items={this.props.goals}
                            remove={this.removeItem}
                        />
                    </div>
                )
            }
        }

        class App extends React.Component {
            componentDidMount () {
                const { store } = this.props
                
                // Fetching fake data from api
                // if promise is resolved
                Promise.all([
                    API.fetchTodos(),
                    API.fetchGoals(),
                // these will run when the request has been resolved
                ]).then(([todos, goals]) => {
                    // console.log('todos', todos)
                    // console.log('goals', goals)
                    store.dispatch(receiveDataAction(todos, goals)) 
                })

                // Causes force update - re-render
                store.subscribe(() => this.forceUpdate())
            }

            render() {
                const { store } = this.props
                const { todos, goals } = store.getState()

                return (
                    <div>
                        <Todos todos={todos} store={store} />
                        <Goals goals={goals} store={store} />
                    </div>
                )
            }
        }

        ReactDOM.render(
            <App store={store} />,
            document.getElementById('app')
        )
    </script>
</body>
</html>

<!-- // Adding UI to Library - review -->
<!-- Actions, Reducers, and createStore -->
<!-- Middleware -->

<!-- 
  NOTE SECTION:

Action Creators: return different actions.

1. Setup 'ACTIONS'
Actions: Object representation of different events that can occur in my application
  - My app has five (action) events that can change the state of the Redux Store.
  - ADD_TODO, REMOVE_TODO, TOGGLE_TODO, ADD_GOAL, REMOVE_GOAL
  - Add different properties in these event objects

2. Setup 'REDUCERS'
Reducers are responsible for is they take in the current state of specific section of the store. (i.e. todos, goals)
  - Reducer function takes in state and action as argument
  - Depending on the 'ACTIONs' (ADD_TODO, REMOVE_TODO, TOGGLE_TODO), go ahead and update/return a brand new state based off of that action

3. Create a 'STORE'
// Call Redux.createStore, passing a 'Reducer'

const store = Redux.createStore(Redux.combineReducers({
  todos,
  goals
}))

Example above, there are TWO Reducers but** 'Redux.combineReducers' combines them, giving back one Reducer
And then pass it to 'createStore'

'store' is an object and now has three different properties 
  a. SUBSCRIBE property
  b. GETSTATE property
  c. DISPATCH property

store contains ALL states in the application, and we can get by...
  a. By calling 'getState()'
  b. Get notified whenever the state changes is specific for 'subscribe()'
  c. Update the state by calling 'Dispatch'
    c1. what I pass dispatch is specific action which is occuring
    c2. Wrap everything inside the action creators. Invoke action creators (removeTodoAction...etc)
        returning actual action object

When dispatch is called...        
4. Redux is going to go through all of Reducers (todos, goals)

5. Whenever we dispatch an action, it's going through every reducers in order to get a new state
  a. If we have a 'goals' reducer that does not respond to specific event / action type that occurred 
      It will simply return previous 'STATE' (default)


6. Subscribe 
  - Creating a few DOM so I can hook up Redux Store onto the actual UI
-->
